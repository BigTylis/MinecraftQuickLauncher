<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launch Minecraft</title>
    <style>
    .video-container {
    	position: fixed; /* Fixed positioning to place it relative to the viewport */
    	bottom: 10px; /* Distance from the bottom of the viewport */
    	right: 10px; /* Distance from the right of the viewport */
    	width: 50%; /* Adjust the width to make the video smaller */
    	padding-bottom: 28.125%; /* Half of the normal 56.25% to maintain aspect ratio */
    	height: 0;
    	background-color: #000; /* Optional: Adds a background color */
    	z-index: 1000; /* Ensures it stays on top of other content */
    	border: 1px solid #ccc; /* Optional: Adds a border around the video */
    	box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Optional: Adds shadow for better visibility */
    }
    .video-container iframe {
    	position: absolute;
    	top: 0;
    	left: 0;
    	width: 100%;
    	height: 100%;
    }
    </style>
    <script>
	var launcherVersionRequired = 2;  // ANY TIME YOU UPDATE THE LAUNCHER APPLICATION PLEASE USE CHANGE THIS NUMBER SO USERS CAN UPDATE
	var clickAnywhereLaunchTriggered = false;

        // Function to set a cookie
        function setCookie(name, value, days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        // Function to get a cookie
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

	// Function to parse query parameters from URL
	function getQueryParams() {
    	var queryParams = {};
    	var queryString = window.location.search.substring(1);
    	var pairs = queryString.split("&");
    	for (var i = 0; i < pairs.length; i++) {
    	    	var pair = pairs[i].split("=");
    	    	queryParams[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
    	}
    	return queryParams;
	}

        // Function to launch Minecraft
        function launchMinecraft() {
	    var queryParams = getQueryParams();
            window.location.href = 'MinecraftJServ://' + launcherVersionRequired + '/' + queryParams.arg1 + '/' + queryParams.arg2 + '/' + queryParams.arg3;
            awaitEndpointResult();
        }

	// Download installation files
	function downloadInstaller() {
	    document.getElementById('autoDownloadInstallerBat').click();
	    document.getElementById('autoDownloadInstallerZip').click();
	}

	// Launch any webpage
	function showVideo() {
	    var videoContainer = document.getElementById('videoContainer');
	    videoContainer.style.display = 'block';
	}

// Wait until the endpoint result is set
function awaitEndpointResult() {
    	while (true) {
        if (getCookie("launchEndpointRecieved") == "true" || localStorage.getItem("launchEndpointRecieved") == "true") {
	    setCookie("launchEndpointRecieved", false, 365);
	    localStorage.removeItem("launchEndpointRecieved");
            window.close();
            break; // Exit the loop when the cookie is found
        }
        setTimeout(() => {
            awaitEndpointResult();
        }, 250);
        break; // Break the loop temporarily to allow setTimeout to execute
    }
}

	// Load different varients of the page based off of query
	function loadPageVarient() {
	    var queryParams = getQueryParams();
	    if(queryParams.arg1 == "install") {
		document.getElementById("installPage").style.display = "block";
		return;
	    }
	    if(queryParams.arg1 == "returnEndpointSuccess") {
		// Mark endpoint recieved
		document.getElementById("launchEndpointSuccess").style.display = "block";
		localStorage.setItem("launchEndpointRecieved", true);
	    	setCookie("launchEndpointRecieved", true, 1);
		window.close();
		return;
	    }
	    if(!queryParams.hasOwnProperty("arg1") || !queryParams.hasOwnProperty("arg2") || !queryParams.hasOwnProperty("arg3")) {
	        document.getElementById("badRequest").style.display = "block";
		return;
	    }
	    document.getElementById("launchMessage").style.display = "block";
	    launchMinecraft();

	    // In case it doesnt launch due to denied request
	    document.addEventListener('click', function(event) {
		if (clickAnywhereLaunchTriggered == false) {
		    clickAnywhereLaunchTriggered = true;
		    launchMinecraft();
		}
    	    });
	}

        window.onload = loadPageVarient;
    </script>
</head>
<body>
    <style>
        #launchMessage {
        display: none;
        font-size: larger;
    }
    </style>
    <div id="launchMessage" style="display: none;">
        <p>Launching...</p>
	<p>(If it wont launch try clicking anywhere on this page to manual launch)</p>
    </div>

    <style>
        #badRequest {
        display: none;
        font-size: larger;
    }
    </style>
    <div id="badRequest" style="display: none;">
        <p>404 not found. Provided query arguments are invalid.</p>
    </div>

    <div id="installPage" style="display: none;">
	
	<div id="videoContainer" class="video-container" style="display:none;">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/5fJck8C4raM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; 	picture-in-picture" allowfullscreen></iframe>
    	</div>

        <p>Welcome to the installation page! This includes a step by step guide on how to install the quick launcher.</p>
	<p>1. Click the button below to download the nessesary files. You may need to allow multiple file downloads if your browser prompts you about it.</p>
	<a href="Files/Install.bat" download="Install.bat" id="autoDownloadInstallerBat" style="display: none;">Download the Bat</a>
	<a href="Files/LaunchApplication.zip" download="LaunchApplication.zip" id="autoDownloadInstallerZip" style="display: none;">Download the Zip</a>
	<button onclick="downloadInstaller()">Download Installer</button>
	<p>2. Once everything has finished downloading, check to make sure you have these two files: Install (batch file) and LaunchApplication (zip file)</p>
	<p>DO NOT extract the zip file. If you already have, this is ok you can just delete the extracted version.</p>
	<p>3. Verify that the Install file and LaunchApplication file are in the same folder. The install file is dependant on the LaunchApplication file being in the same place.</p>
	<p>4. Double click the Install file to run it. If the "Windows protected your pc" window appears, click "more info" then "Run Anyway". This is simply a windows security measure and does not mean the file is malicious in any way. The file will require administrative permissions so when it says "Do you want to allow this app to make changes to your device" select yes (required).</p>
	<p>5. Wait for the installer to finish. If there are no issues installing a window should come up confirming it succeeded. You may close the command prompt window (black box) and delete both the Install file and LaunchApplication file.</p>
	<p>6. Enjoy being able to use quick launch link schemes! You have completed the tutorial!</p>
	<p></p>
	<p>Not the brightest? Thats OK! You can watch this youtube video to get a visual representation of the steps presented.</p>
	<button onclick="showVideo()">Video Tutorial</button>
    </div>

    <div id="launchEndpointSuccess" style="display: none;">
        <p>Endpoint recieved!</p>
    </div>
</body>
</html>